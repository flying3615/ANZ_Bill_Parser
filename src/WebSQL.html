<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web SQL</title>
    <script src="xlsx.full.min.js"></script>
    <script src="ssf.js"></script>
    <script src="echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"
            integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
</head>
<body>
<div class="container">
    <input class="form-control" type="file" id="files" name="files[]" multiple/>

    <hr/>
    <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
            <a class="nav-item nav-link active" id="nav-total-tab" data-toggle="tab" href="#nav-total" role="tab"
               aria-controls="nav-total" aria-selected="true">Total</a>

            <a class="nav-item nav-link" id="nav-cost-tab" data-toggle="tab" href="#nav-cost" role="tab"
               aria-controls="nav-cost" aria-selected="false">cost</a>

            <a class="nav-item nav-link" id="nav-income-tab" data-toggle="tab" href="#nav-income" role="tab"
               aria-controls="nav-income" aria-selected="false">income</a>
        </div>
    </nav>

    <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade show active" id="nav-total" role="tabpanel" aria-labelledby="nav-total-tab">
            <div class="slidecontainer">
                <b>$10</b>
                <input type="range" min="10" max="1000" value="50" step="10" class="slider" id="myRange">
                <b>$1000</b>
                <div id="scaleMoney"></div>
            </div>
            <div>
                <button class="btn" id="resetBtn">Reset</button>
            </div>

            <div class="row">
                <div id="totalSumm" style="width: 100%;height:400px;"></div>
            </div>

            <div>
                <table id="detailTable" class="table">
                </table>
            </div>

        </div>
        <div class="tab-pane fade" id="nav-cost" role="tabpanel" aria-labelledby="nav-cost-tab">...</div>
        <div class="tab-pane fade" id="nav-income" role="tabpanel" aria-labelledby="nav-income-tab">...</div>
    </div>
</div>
<script>


	const db = openDatabase('mydb', '1.0', 'my first database', 2 * 1024 * 1024);

	(function () {

		const moneySlider = document.querySelector('#myRange')
		const scaleMoney = document.querySelector('#scaleMoney')

		const totalSummChart = echarts.init(document.querySelector('#totalSumm'))


		const dbErrorHandler = (tx, err) => {
			console.log(err)
		}

		function _dateFomater(date) {
			const result = SSF.format('yyyy-mm-dd', date)
			return result
		}

		function _getResultPromise(sql, params = []) {
			console.log('sql =', sql)
			return new Promise((resolve, reject) => {
				db.transaction(tx => {
					tx.executeSql(sql, params, (tx, res) => resolve(Array.from(res.rows)), reject)
				})
			})
		}

		async function getSumAmountByMonth(minimun) {
			let sel = 'SELECT sum(amount) AS sumAmount, avg(balance) AS balance, strftime("%Y-%m","transaction_date") AS month FROM bill GROUP BY strftime("%Y-%m","transaction_date")'
			if (minimun) {
				sel = sel + ' having sumAmount >= ' + minimun
			}
			const result = await _getResultPromise(sel)
			return result

		}

		async function getCostAmountByMonth(minimun) {

			let sel = 'SELECT sum(amount) AS cost, strftime("%Y-%m","transaction_date") AS month FROM bill WHERE cast(amount AS DECIMAL) < 0 GROUP BY strftime("%Y-%m","transaction_date")'

			if (minimun) {
				sel = sel + ' having cost <= ' + (-minimun)
			}
			const result = await _getResultPromise(sel)
			return result

		}

		async function getIncomeAmountByMonth(minimun) {
			let sel = 'SELECT sum(amount) AS income, strftime("%Y-%m","transaction_date") AS month FROM bill WHERE cast(amount AS DECIMAL) > 0 GROUP BY strftime("%Y-%m","transaction_date")'
			if (minimun) {
				sel += ' having income >= ' + minimun
			}
			const result = await _getResultPromise(sel)
			return result
		}

		async function getCostAmountByCode(minimun = 0) {
			let sel = 'SELECT sum(amount) AS cost, details, code FROM bill WHERE cast(amount AS DECIMAL) < 0 GROUP BY code'
			if (minimun) {
				sel += ' having cost <= ' + (-minimun)
			}
			const result = await _getResultPromise(sel)
			return result
		}


		moneySlider.oninput = () => {
			scaleMoney.innerHTML = moneySlider.value
			let minimun = moneySlider.value

			renderTotalChart(minimun)
		}

		function resetTotal() {
			renderTotalChart()
		}

		function renderTotalChart(minimun) {

			Promise.all([
				getSumAmountByMonth(minimun),
				getCostAmountByMonth(minimun),
				getIncomeAmountByMonth(minimun)
			]).then(values => {
				console.log('values', values)
				const total = values[0]
				const cost = values[1]
				const income = values[2]
				//suppose every month spent money
				const xAxisMonths = cost.map(r => r.month)

				const amountData = total.map(v => Number(v.sumAmount.toFixed(0)))
				const balanceData = total.map(v => Number(v.balance.toFixed(0)))
				const costData = cost.map(v => Number((-v.cost).toFixed(0)))
				const incomeData = income.map(v => Number(v.income.toFixed(0)))

				const option = {
					title: {
						text: 'Bill'
					},
					tooltip: {
						trigger: 'axis'
					},
					legend: {
						data: ['profit', 'balance', 'cost', 'income']
					},
					toolbox: {
						show: true,
						feature: {
							dataZoom: {
								yAxisIndex: 'none'
							},
							dataView: {readOnly: false},
							magicType: {type: ['line', 'bar']},
							restore: {},
							saveAsImage: {}
						}
					},
					xAxis: {
						type: 'category',
						boundaryGap: false,
						data: xAxisMonths
					},
					yAxis: {
						type: 'value'
					},
					series: [
						{
							name: 'profit', type: 'line', data: amountData,
							markPoint: {
								data: [
									{type: 'max', name: '最大值'},
									{type: 'min', name: '最小值'}
								]
							},
							markLine: {
								data: [
									{type: 'average', name: '平均值'}
								]
							}
						},
						{
							name: 'balance', type: 'line', data: balanceData,
							markPoint: {
								data: [
									{type: 'max', name: '最大值'},
									{type: 'min', name: '最小值'}
								]
							},
							markLine: {
								data: [
									{type: 'average', name: '平均值'}
								]
							}
						},
						{
							name: 'cost', type: 'line', data: costData,
							markPoint: {
								data: [
									{type: 'max', name: '最大值'},
									{type: 'min', name: '最小值'}
								]
							},
							markLine: {
								data: [
									{type: 'average', name: '平均值'}
								]
							}
						},
						{
							name: 'income', type: 'line', data: incomeData,
							markPoint: {
								data: [
									{type: 'max', name: '最大值'},
									{type: 'min', name: '最小值'}
								]
							},
							markLine: {
								data: [
									{type: 'average', name: '平均值'}
								]
							}
						}
					]
				};
				console.log(option, null, 2)
				totalSummChart.setOption(option)
			})


		}

		function insertData(data) {
			const sheetCols = Object.keys(data[0]).map(k => String(k).replace(/[\s,\/]/g, '_')).join(',')
//          print columons headers
//			console.log(sheetCols)
			db.transaction(function (tx) {

				tx.executeSql('DROP TABLE bill');
				tx.executeSql(`CREATE TABLE IF NOT EXISTS bill (
          ${sheetCols}
        )`);
				data.forEach((item) => {
					const values = Object.values(item).map((v, index) => {
						if (v) {
							//first two are 'transaction date' & 'processed date'
							return index <= 1 ? `"${_dateFomater(v)}"` : `"${v}"`
						} else {
							return 'null'
						}
					}).join(',')

					const insertSQL = `INSERT INTO bill (${sheetCols}) VALUES (${values})`
					tx.executeSql(insertSQL);
				})

			})
		}


		function handleFileSelect(evt) {
			const files = evt.target.files
			for (let i = 0; i < files.length; i++) {
				const file = files[i]
				const fileReader = new FileReader()
				fileReader.readAsArrayBuffer(file)
				fileReader.onload = e => {
					const data = new Uint8Array(fileReader.result);
					const arr = new Array();
					for (let k = 0; k != data.length; ++k) arr[k] = String.fromCharCode(data[k]);
					const bstr = arr.join("");

					const workbook = XLSX.read(bstr, {type: "binary"});

					const first_sheet_name = workbook.SheetNames[0];
					const worksheet = workbook.Sheets[first_sheet_name];
					const jsonData = XLSX.utils.sheet_to_json(worksheet, {raw: true})

					insertData(jsonData)
				}

			}

			renderTotalChart()

		}

		document.querySelector('#files').addEventListener('change', handleFileSelect)
		document.querySelector('#resetBtn').addEventListener('click', resetTotal)

	})()
</script>
</body>
</html>