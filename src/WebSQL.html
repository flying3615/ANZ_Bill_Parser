<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Web SQL</title>
	<script src="lib/xlsx.full.min.js"></script>
	<script src="lib/ssf.js"></script>
	<script src="util.js"></script>
	<script src="analysisBillAsyn.js"></script>
	<script src="lib/echarts.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
					integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
					crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
					integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
					crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"
					integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
					crossorigin="anonymous"></script>
	<link rel="stylesheet" type="text/css"
				href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">

	<style>
		ul > li {
			display: inline-block;
		}
	</style>
</head>
<body>
<div class="container">

	<input class="form-control" type="file" id="files" name="files[]" multiple/>

	<hr/>

	<div class="tab-content" id="nav-tabContent">
		<div class="tab-pane fade show active" id="nav-total" role="tabpanel" aria-labelledby="nav-total-tab">
			<div class="slidecontainer">
				<b>$10</b>
				<input type="range" min="10" max="1000" value="50" step="10" class="slider" id="myRange">
				<b>$1000</b>
				<div id="scaleMoney"></div>
			</div>
			<div>
				<button class="btn" id="resetBtn">Reset</button>
			</div>
			<section>
				<div class="card" id="totalCard" style="display: none">
					<h5 class="card-header">Total Summary</h5>
					<div class="card-body">
						<div id="totalSumm" style="width: 1000px;height:500px;"></div>
					</div>
				</div>
			</section>
			<br/>
			<br/>
			<section>
				<div class="card" id="portionCard" style="display: none">
					<h5 class="card-header" id="pieCardTitle">Portion Summary</h5>
					<div class="card-body">
						<!--show it when pie chart showing, onclick-->
						<!-- dynamic table -->
						<input type="text" id="category" placeholder="customize category">
						<button id="addCategoryBtn">Add</button>
						<ul id="costCategory"></ul>
						<table id="dynamicTable" class="table">
						</table>
						<div id="pieDetail" style="width: 800px;height:500px;"></div>
					</div>
				</div>
			</section>
			<br/>

			<br/>
			<section>
				<div class="card" id="costDetailsCard" style="display: none">
					<h5 class="card-header" id="tableCardTitle">Cost Details</h5>
					<div class="card-body">
						<table id="detailTable" class="table">
						</table>
					</div>
				</div>
			</section>

		</div>
	</div>
</div>
<script>

	const db = openDatabase('mydb', '1.0', 'my first database', 2 * 1024 * 1024);

	(function () {

		let uniqCodes

		const moneySlider = document.querySelector('#myRange')
		const scaleMoney = document.querySelector('#scaleMoney')
		const detailTable = document.querySelector('#detailTable')
		const fileInputBtn = document.querySelector('#files')
		const resetBtn = document.querySelector('#resetBtn')

		const portionCard = document.querySelector('#portionCard')
		const costDetailsCard = document.querySelector('#costDetailsCard')

		const addCategoryBtn = document.querySelector('#addCategoryBtn')

		const pieCardTitle = document.querySelector('#pieCardTitle')
		const tableCardTitle = document.querySelector('#tableCardTitle')

		const dynamicCategoryTable = document.querySelector('#dynamicTable')

		//category adding handler
		addCategoryBtn.addEventListener('click', () => {
			const category = document.querySelector('#category').value
			insertCategory(category)

			addCategoryColumn(Array.from(document.querySelectorAll('#dynamicTable tr')), category)

			createCategoryLi(document.querySelector('#costCategory'), category)

		})


		const totalSummChart = echarts.init(document.querySelector('#totalSumm'))
		const detailsChart = echarts.init(document.querySelector('#pieDetail'))

		moneySlider.addEventListener('input', () => {
			scaleMoney.innerHTML = moneySlider.value
			const minimum = moneySlider.value
			// limit the minimum cost
			renderTotalChart(minimum)
			//TODO constrain portion & table too??
		})

		function resetTotal() {
			renderTotalChart()
		}

		function renderTotalChart(minimum) {

			Promise.all([
				getSumAmountByMonth(minimum),
				getCostAmountByMonth(minimum),
				getIncomeAmountByMonth(minimum)
			]).then(values => {
				const total = values[0]
				const cost = values[1]
				const income = values[2]
				//suppose every month spent money
				const xAxisMonths = cost.map(r => r.month)

				const amountData = total.map(v => Number(v.sumAmount.toFixed(0)))
				const balanceData = total.map(v => Number(v.balance.toFixed(0)))
				const costData = cost.map(v => Number((-v.cost).toFixed(0)))
				const incomeData = income.map(v => Number(v.income.toFixed(0)))

				const option = {
					title: {
						text: 'Bill'
					},
					tooltip: {
						trigger: 'axis'
					},
					legend: {
						data: ['profit', 'balance', 'cost', 'income']
					},
					toolbox: {
						show: true,
						feature: {
							dataZoom: {
								yAxisIndex: 'none'
							},
							dataView: {readOnly: false},
							magicType: {type: ['line', 'bar']},
							restore: {},
							saveAsImage: {}
						}
					},
					xAxis: {
						type: 'category',
						boundaryGap: false,
						data: xAxisMonths
					},
					yAxis: {
						type: 'value',
						axisLabel: {
							formatter: '$ {value}'
						}
					},
					series: [
						{
							name: 'profit', type: 'line', data: amountData,
							markPoint: {
								data: [
									{type: 'max', name: '最大值'},
									{type: 'min', name: '最小值'}
								]
							},
							markLine: {
								data: [
									{type: 'average', name: '平均值'}
								]
							}
						},
						{
							name: 'balance', type: 'line', data: balanceData,
							markPoint: {
								data: [
									{type: 'max', name: '最大值'},
									{type: 'min', name: '最小值'}
								]
							}
						},
						{
							name: 'cost', type: 'line', data: costData,
							markPoint: {
								data: [
									{type: 'max', name: '最大值'},
									{type: 'min', name: '最小值'}
								]
							},
							markLine: {
								data: [
									{type: 'average', name: '平均值'}
								]
							}
						},
						{
							name: 'income', type: 'line', data: incomeData,
							markPoint: {
								data: [
									{type: 'max', name: '最大值'},
									{type: 'min', name: '最小值'}
								]
							},
							markLine: {
								data: [
									{type: 'average', name: '平均值'}
								]
							}
						}
					]
				};
				totalSummChart.setOption(option)
				//show chart
				document.querySelector('#totalCard').style.display = 'block'
			})

		}


		function handleFileSelect(evt) {
			const files = evt.target.files
			for (let i = 0; i < files.length; i++) {
				const file = files[i]
				const fileReader = new FileReader()
				fileReader.readAsArrayBuffer(file)
				fileReader.onload = e => {
					const jsonData = readExcelData(fileReader)
					createBillTable(jsonData)
						.then(() => sortCodeFromDetails())
						.then(() => renderTotalChart())
						.catch(e => console.error(e))
				}
			}
		}

		fileInputBtn.addEventListener('change', handleFileSelect)
		resetBtn.addEventListener('click', resetTotal)

		//handle month click
		totalSummChart.on('click', params => {

			//show pie chart
			portionCard.style.display = 'block'
			//show cost details table
			costDetailsCard.style.display = 'block'

			detailTable.innerHTML = ''
			const headerRow = detailTable.insertRow()
			headerRow.insertCell(0).innerText = 'Date'
			headerRow.insertCell(1).innerText = 'Amount'
			headerRow.insertCell(2).innerText = 'Balance'
			headerRow.insertCell(3).innerText = 'Details'
			headerRow.insertCell(4).innerText = 'Code'
			//get detail by month...

			getDetailAmountByMonth(params.name, params.seriesName).then(resultSet => {
				resultSet.forEach(record => {
					const row = detailTable.insertRow()
					row.insertCell(0).innerText = record['Transaction_Date']
					row.insertCell(1).innerText = record['Amount']
					row.insertCell(2).innerText = record['Balance']
					row.insertCell(3).innerText = record['Details']
					row.insertCell(4).innerText = record['Code']
				})

			})

			//dynamic table insert code column
			dynamicCategoryTable.innerText = ''
			const headerR = dynamicCategoryTable.insertRow()
			headerR.insertCell(0).innerText = 'Code'
			getUniqCodeorDetails(params.name, params.seriesName).then(resultSet => {
				uniqCodes = resultSet.map(r => r.Code)
				uniqCodes.forEach(code => {
					const row = dynamicCategoryTable.insertRow()
					row.insertCell(0).innerText = code || 'Unknown'
				})
			})

			getCategories().then(cats => {
				cats.forEach(c => {
					//init dynamic table
					addCategoryColumn(Array.from(document.querySelectorAll('#dynamicTable tr')), c.name)
					//init category ul
					createCategoryLi(document.querySelector('#costCategory'), c.name)
				})
			})

			getCostAmountByCodeOrDetails(params.name, params.seriesName).then(resultSet => {
				if (!['cost', 'income'].includes(params.seriesName)) {
					// hide pie and table
					portionCard.style.display = 'none'
					costDetailsCard.style.display = 'none'
					return
				}

				pieCardTitle.innerText = `${params.name} ${params.seriesName} portion`
				tableCardTitle.innerText = `${params.name} ${params.seriesName} details`
				const seriesData = resultSet.map(r => {
					return {
						value: Math.abs(r.cost),
						//1742 C???
						name: ((r.Code && !r.Code.includes('1742')) ? r.Code : r.Details || 'Unknown')
					}
				})

				const legendData = resultSet.map(r => (r.Code && !r.Code.includes('1742')) ? r.Code : r.Details || 'Unknown')

				const option = {
					title: {
						text: `${params.seriesName} Summary`,
						x: 'center'
					},
					tooltip: {
						trigger: 'item',
						formatter: "{a} <br/>{b} : {c} ({d}%)"
					},
					legend: {
						orient: 'vertical',
						left: 'left',
						data: legendData
					},
					toolbox: {
						show: true,
						feature: {
							mark: {show: true},
							dataView: {show: true, readOnly: false},
							magicType: {
								show: true,
								type: ['pie', 'funnel']
							},
							restore: {show: true},
							saveAsImage: {show: true}
						}
					},
					series: [
						{
							name: 'Amount',
							type: 'pie',
							radius: '55%',
							center: ['50%', '60%'],
							data: seriesData
						}
					]
				};

				detailsChart.setOption(option)

			})

		})

	})()
</script>
</body>
</html>